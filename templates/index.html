<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Plays Pokemon</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'FusionPixel';
            /* 确保字体文件路径正确 */
            src: url('/static/fusion-pixel-10px-monospaced-ko.ttf.woff') format('woff');
            font-display: swap;
            /* 移除unicode-range限制，让字体支持所有字符包括英文和数字 */
        }

        body {
            background-color: black;
            color: white;
            /* 将 FusionPixel 放在前面，优先用于中文 */
            font-family: 'FusionPixel', 'Press Start 2P', monospace;
            margin: 0;
            padding: 10px 20px 20px 20px;
            line-height: 1.6;
            font-size: 14px;
            /* 保持像素风格渲染 */
            image-rendering: pixelated;
            -webkit-font-smoothing: none;
            font-smooth: never;
            text-rendering: optimizeSpeed;
            /* 隐藏滚动条 */
            overflow: hidden;
        }
        
        /* 隐藏所有滚动条 */
        ::-webkit-scrollbar {
            display: none;
        }
        
        /* 对于Firefox */
        html {
            scrollbar-width: none;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 60px;
        }

        h1 {
            font-size: 28px;
            text-align: center;
            margin-top: 0px;
            margin-bottom: 0px;
            letter-spacing: 2px;
        }

        .subtitle {
            font-size: 24px;
            text-align: center;
            margin-bottom: 0px;
            letter-spacing: 1px;
        }
        
        /* 标题强制使用英文字体，避免回退 */
        h1,
        .subtitle {
            font-family: 'Press Start 2P', monospace;
        }

        #runtime {
            font-size: 18px;
            text-align: center;
            margin-top: 0px;
            margin-bottom: 0px;
            letter-spacing: 1px;
        }

        #danmaku-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            max-height: 600px;
            overflow-y: auto;
            scroll-behavior: smooth;
            /* 确保弹幕列表使用FusionPixel字体 */
            font-family: 'FusionPixel', monospace;
        }

        /* 这是关键的修改部分 */
        .danmaku-item {
            display: flex;
            justify-content: space-between;
            /* * [核心修改]
             * 将 align-items 从 baseline 改为 center。
             * 这使得 username 和 command 两个 span 容器在垂直方向上居中对齐，
             * 解决了因字体基线不同导致的错位问题。
             */
            align-items: center; 
            margin-bottom: 2px;
            padding: 1px 0;
            /* 统一设置字体大小和行高以获得更好的一致性 */
            font-size: 14px;
            line-height: 1.1;
        }

        .username {
            flex: 1;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            /* 稍微调整一下最大宽度，给右侧留出足够空间 */
            max-width: calc(100% - 100px);
            /* 确保用户名使用FusionPixel字体 */
            font-family: 'FusionPixel', monospace;
        }

        .command {
            text-align: right;
            min-width: 80px;
            margin-left: 20px;
            font-weight: bold;
            text-shadow: 1px 1px 0px #333;
            /* 确保命令文本使用FusionPixel字体 */
            font-family: 'FusionPixel', monospace;
        }

        /* 投票占比显示条 */
        .vote-bar-container {
            margin: 0;
            text-align: center;
            position: relative;
        }

        .vote-bar-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
            padding: 0;
        }
        
        .vote-labels {
            font-family: 'FusionPixel', 'Press Start 2P', monospace;
            font-size: 16px;
            color: #fff;
            text-shadow: 1px 1px 0px #000;
            font-weight: bold;
            margin: 0;
            image-rendering: pixelated;
            -webkit-font-smoothing: none;
            font-smooth: never;
            transition: color 0.3s ease, text-shadow 0.3s ease;
        }

        .vote-labels.active {
            color: #fff;
            text-shadow: 1px 1px 0px #000;
        }

        .vote-labels.inactive {
            color: #999;
            text-shadow: 1px 1px 0px #444;
        }

        .vote-bar {
            flex: 1;
            height: 14px;
            background-color: white;
            border: none;
            position: relative;
            margin: 0;
            image-rendering: pixelated;
            background-image: 
                linear-gradient(90deg, #666 0px, #666 2px, transparent 2px),
                linear-gradient(90deg, #666 0px, #666 2px, transparent 2px),
                linear-gradient(0deg, #666 0px, #666 2px, transparent 2px),
                linear-gradient(0deg, #666 0px, #666 2px, transparent 2px);
            background-position: 0 0, 0 100%, 0 0, 100% 0;
            background-size: 100% 2px, 100% 2px, 2px 100%, 2px 100%;
            background-repeat: no-repeat;
        }

        .vote-divider {
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background-color: black;
            transition: left 0.3s ease;
            pointer-events: none;
            image-rendering: pixelated;
            z-index: 2;
        }

        .vote-arrow {
            position: absolute;
            top: calc(50% + 1px);
            transform: translateY(-50%);
            font-family: 'Press Start 2P', monospace;
            font-size: 12px;
            line-height: 1;
            color: #000;
            opacity: 0;
            pointer-events: none;
            image-rendering: pixelated;
            -webkit-font-smoothing: none;
            font-smooth: never;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 12px;
            width: 12px;
        }

        .vote-arrow.show {
            opacity: 1;
        }

        .vote-arrow.left {
            right: 4px;
        }

        .vote-arrow.right {
            left: 4px;
        }

        .vote-threshold {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: repeating-linear-gradient(
                to bottom,
                #666 0px,
                #666 2px,
                transparent 2px,
                transparent 4px
            );
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            image-rendering: pixelated;
            z-index: 1;
        }

        .vote-threshold.show {
            opacity: 1;
        }

        /* 投票条抖动动画 - 不同强度 */
        @keyframes vote-bar-shake-light {
            0% { transform: translateX(0); }
            25% { transform: translateX(0.5px); }
            50% { transform: translateX(0); }
            75% { transform: translateX(0.5px); }
            100% { transform: translateX(0); }
        }

        @keyframes vote-bar-shake-medium {
            0% { transform: translateX(0); }
            25% { transform: translateX(1px); }
            50% { transform: translateX(0); }
            75% { transform: translateX(1px); }
            100% { transform: translateX(0); }
        }

        @keyframes vote-bar-shake-strong {
            0% { transform: translateX(0); }
            25% { transform: translateX(2px); }
            50% { transform: translateX(0); }
            75% { transform: translateX(2px); }
            100% { transform: translateX(0); }
        }

        @keyframes vote-bar-shake-extreme {
            0% { transform: translateX(0); }
            20% { transform: translateX(3px); }
            40% { transform: translateX(0); }
            60% { transform: translateX(3px); }
            80% { transform: translateX(0); }
            100% { transform: translateX(0); }
        }

        .vote-bar.shake-light {
            animation: vote-bar-shake-light 0.4s ease-in-out 2;
        }

        .vote-bar.shake-medium {
            animation: vote-bar-shake-medium 0.35s ease-in-out 3;
        }

        .vote-bar.shake-strong {
            animation: vote-bar-shake-strong 0.3s ease-in-out 3;
        }

        .vote-bar.shake-extreme {
            animation: vote-bar-shake-extreme 0.25s ease-in-out 4;
        }

        .vote-counts {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #ccc;
        }

        /* 模式特定布局 */
        .freedom-layout {
            display: block;
        }
        
        .order-layout {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* 获胜指令显示 */
        .winning-command {
            margin: 0px 0;
            text-align: center;
        }
        
        .command-display {
            font-family: 'FusionPixel', monospace;
            font-size: 14px;
            color: #fff;
            margin: 2px 0;
            /* 保持像素风格渲染 */
            image-rendering: pixelated;
            -webkit-font-smoothing: none;
            font-smooth: never;
            text-rendering: optimizeSpeed;
            line-height: 1.1;
        }
        
        /* 前3名指令列表 */
        .top-commands {
            margin: 2px 0;
            padding: 0;
        }
        
        .command-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .command-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1px 10px;
            margin-bottom: 2px;
            font-family: 'FusionPixel', monospace;
            font-size: 14px;
            line-height: 1.1;
            /* 保持像素风格渲染 */
            image-rendering: pixelated;
            -webkit-font-smoothing: none;
            font-smooth: never;
            text-rendering: optimizeSpeed;
        }
        
        .command-name {
            flex: 1;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: calc(100% - 100px);
            color: #fff;
            font-weight: bold;
        }
        
        .command-votes {
            text-align: right;
            min-width: 80px;
            margin-left: 20px;
            color: #ccc;
            font-weight: bold;
            text-shadow: 1px 1px 0px #333;
        }
        
        /* 秩序模式下的缩短弹幕列表 */
        .order-danmaku {
            list-style: none;
            padding: 2px;
            margin: 0;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            max-height: 200px;
            overflow: hidden;
        }
        
        .order-danmaku .danmaku-item {
            padding: 1px 0px;
            margin: 1px 0;
            font-size: 14px;
            line-height: 1.1;
        }

        .democracy-layout {
            display: none;
        }

        /* 民主模式布局 */
        .democracy-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .winning-command {
            text-align: center;
            padding: 2px;

        }

        .winning-command h2 {
            margin: 0 0 0px 0;
            font-size: 16px;
            color: #fff;
        }

        .winning-command .command-display {
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            margin: 2px 0;
        }

        .winning-command .vote-count {
            font-size: 14px;
            color: #ccc;
        }

        .top-commands {

            padding: 0px;
        }

        .top-commands h3 {
            margin: 0 0 0px 0;
            font-size: 14px;
            color: #fff;
            text-align: center;
        }

        .command-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .command-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 12px;
        }

        .command-name {
            color: #fff;
        }

        .command-votes {
            color: #ccc;
        }

        .democracy-danmaku {
      
            background-color: #111;
            padding: 15px;
            max-height: 200px;
        }

        .democracy-danmaku h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #fff;
            text-align: center;
        }

        .democracy-danmaku-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 150px;
            overflow-y: auto;
        }

        .democracy-danmaku-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
            padding: 1px 0;
            font-size: 11px;
        }

        .democracy-username {
            flex: 1;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: calc(100% - 80px);
        }

        .democracy-command {
            text-align: right;
            min-width: 60px;
            margin-left: 10px;
            color: #ffff00;
        }

        /* 隐藏/显示类 */
        .hidden {
            display: none !important;
        }

        .refresh-info {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 10px;
            opacity: 0.7;
        }

        .instructions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            margin: 0;
            padding: 2px 2px;
            border-top: 3px dashed #666;
            background-color: black;
            font-family: 'FusionPixel', monospace;
            font-size: 10px;
            line-height: 1.4;
            z-index: 100;
        }

        .instructions h3 {
            margin: 0 0 1px 0;
            font-size: 14px;
            color: #fff;
            text-align: center;
        }

        .instructions .command-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 1px;
        }

        .instructions .command-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        .instructions .command-key {
            color: #ffff00;
        }

        .instructions .command-desc {
            color: #cccccc;
        }

        /* * [代码清理] 
         * 之前复杂的、带有 !important 的选择器已被移除。
         * 字体和渲染相关的属性已在 body 和 .danmaku-item 中继承，无需重复强制设置。
         */

    </style>
    <script>
        let eventSource;
        let startTime = null;
        let runtimeInterval = null;
        let currentMode = 'freedom'; // 当前模式
        let modeInfo = {}; // 模式信息
        let democracyInfo = {}; // 民主模式信息
        
        // 格式化运行时间为中文显示
        function formatRuntimeChinese(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            // 始终显示所有时间单位，即使为0
            let result = days + '天 ' + hours + '时 ' + minutes + '分 ' + secs + '秒';
            
            return result;
        }
        
        // 更新运行时间显示
        function updateRuntime() {
            if (startTime) {
                const currentTime = Math.floor(Date.now() / 1000);
                const runtime = currentTime - startTime;
                document.getElementById('runtime').textContent = formatRuntimeChinese(runtime);
            }
        }
        
        // 启动运行时间计时器
        function startRuntimeTimer() {
            if (runtimeInterval) {
                clearInterval(runtimeInterval);
            }
            runtimeInterval = setInterval(updateRuntime, 1000);
        }
        
        
        // 更新投票条位置和标签样式（从左到右表示自由支持率100%-0%）
        function updateVoteBar(freedomSupport, orderSupport, showAnimation = false, forceShake = false) {
            // 直接使用传入的支持率百分比，确保在1-99%范围内
            let freedomPercentage = Math.max(1, Math.min(99, freedomSupport || 50)); // 默认50%，限制在1-99%
            
            const divider = document.getElementById('vote-divider');
            const arrow = document.getElementById('vote-arrow');
            const threshold = document.getElementById('vote-threshold');
            const voteBar = document.querySelector('.vote-bar');
            
            // 检测是否需要触发抖动效果（低支持率或高支持率）
            const previousPercentage = parseFloat(divider?.dataset?.previousPercentage || 50);
            const shouldShakeLow = (freedomPercentage <= 5 && freedomPercentage < previousPercentage) || forceShake;
            const shouldShakeHigh = (freedomPercentage >= 95 && freedomPercentage > previousPercentage) || forceShake;
            const shouldShake = shouldShakeLow || shouldShakeHigh;
            
            // 根据支持率计算抖动强度
            let shakeIntensity = 'light';
            if (freedomPercentage <= 1) {
                shakeIntensity = 'extreme';
            } else if (freedomPercentage <= 2) {
                shakeIntensity = 'strong';
            } else if (freedomPercentage <= 3.5) {
                shakeIntensity = 'medium';
            } else if (freedomPercentage <= 5) {
                shakeIntensity = 'light';
            } else if (freedomPercentage >= 99) {
                shakeIntensity = 'extreme';
            } else if (freedomPercentage >= 98) {
                shakeIntensity = 'strong';
            } else if (freedomPercentage >= 96.5) {
                shakeIntensity = 'medium';
            } else if (freedomPercentage >= 95) {
                shakeIntensity = 'light';
            }
            
            // 保存当前百分比用于下次比较
            if (divider) {
                divider.dataset.previousPercentage = freedomPercentage;
            }
            
            if (divider) {
                // 计算黑线位置：从左到右表示自由支持率100%-0%
                // 所以黑线位置 = 100% - 自由支持率
                const dividerPosition = 100 - freedomPercentage;
                
                // 获取当前位置
                const currentLeft = parseFloat(divider.style.left) || 50;
                
                // 显示移动方向箭头（直接显示，停留1秒）
                if (showAnimation && arrow && Math.abs(dividerPosition - currentLeft) > 0.1) {
                    if (dividerPosition < currentLeft) {
                        // 自由支持率增加，黑线向左移动，显示 <
                        arrow.innerHTML = '&lt;';
                        arrow.className = 'vote-arrow left';
                        arrow.style.opacity = '1';
                    } else {
                        // 自由支持率减少，黑线向右移动，显示 >
                        arrow.innerHTML = '&gt;';
                        arrow.className = 'vote-arrow right';
                        arrow.style.opacity = '1';
                    }
                    
                    // 2秒后隐藏箭头
                    setTimeout(() => {
                        if (arrow) {
                            arrow.style.opacity = '0';
                        }
                    }, 2000);
                }
                
                // 设置分割线位置：标记自由支持率在进度条上的位置
                // 左边100%自由支持率，右边0%自由支持率
                divider.style.left = dividerPosition + '%';
            }
            
            // 触发抖动效果
            if (shouldShake && voteBar) {
                // 移除之前的所有抖动类
                voteBar.classList.remove('shake-light', 'shake-medium', 'shake-strong', 'shake-extreme');
                // 强制重绘
                void voteBar.offsetWidth;
                // 添加对应强度的抖动类
                voteBar.classList.add(`shake-${shakeIntensity}`);
                
                // 记录抖动日志
                if (forceShake) {
                    console.log(`Vote bar shake triggered by backend (${shakeIntensity}): freedom support at extreme and vote received`);
                } else if (shouldShakeLow) {
                    console.log(`Vote bar shake triggered by frontend (${shakeIntensity}): freedom support ${freedomPercentage.toFixed(1)}% and decreasing`);
                } else if (shouldShakeHigh) {
                    console.log(`Vote bar shake triggered by frontend (${shakeIntensity}): freedom support ${freedomPercentage.toFixed(1)}% and increasing`);
                }
                
                // 根据抖动强度设置不同的动画持续时间
                const animationDuration = {
                    'light': 800,    // 0.4s * 2 = 0.8s
                    'medium': 1050,  // 0.35s * 3 = 1.05s
                    'strong': 900,   // 0.3s * 3 = 0.9s
                    'extreme': 1000  // 0.25s * 4 = 1.0s
                };
                
                // 动画结束后移除类
                setTimeout(() => {
                    voteBar.classList.remove(`shake-${shakeIntensity}`);
                }, animationDuration[shakeIntensity]);
            }
            
            // 更新阈值虚线显示（根据投票后的结果模式）
            if (threshold) {
                // 根据自由支持率判断投票后的结果模式
                let resultMode;
                if (freedomPercentage > 50) {
                    resultMode = '自由';
                } else if (freedomPercentage < 25) {
                    resultMode = '秩序';
                } else {
                    // 在25%-50%之间，保持当前模式
                    resultMode = document.querySelector('.freedom-layout').style.display !== 'none' ? '自由' : '秩序';
                }
                
                if (resultMode === '自由') {
                    // 投票后结果是自由模式时，在25%位置显示虚线（对应进度条75%位置）
                    threshold.style.left = '75%';
                    threshold.className = 'vote-threshold show';
                } else if (resultMode === '秩序') {
                    // 投票后结果是秩序模式时，在50%位置显示虚线（对应进度条50%位置）
                    threshold.style.left = '50%';
                    threshold.className = 'vote-threshold show';
                }
            }
            
            // 更新投票标签样式
            updateVoteLabels();
        }
        
        // 更新投票标签的激活状态
        function updateVoteLabels() {
            const voteLabels = document.querySelectorAll('.vote-labels');
            if (voteLabels.length >= 2) {
                const freedomLabel = voteLabels[0]; // 第一个是"自由"
                const orderLabel = voteLabels[1];   // 第二个是"秩序"
                
                if (modeInfo.current_mode === '自由') {
                    freedomLabel.className = 'vote-labels active';
                    orderLabel.className = 'vote-labels inactive';
                } else if (modeInfo.current_mode === '秩序') {
                    freedomLabel.className = 'vote-labels inactive';
                    orderLabel.className = 'vote-labels active';
                } else {
                    // 默认状态，两个都是正常颜色
                    freedomLabel.className = 'vote-labels';
                    orderLabel.className = 'vote-labels';
                }
            }
        }
        
        // 切换布局模式
        function switchLayout(mode) {
            const freedomLayout = document.querySelector('.freedom-layout');
            const orderLayout = document.querySelector('.order-layout');
            const freedomDanmakuList = document.getElementById('danmaku-list');
            const orderDanmakuList = document.getElementById('order-danmaku-list');
            
            if (mode === '秩序') {
                // 从自由模式切换到秩序模式
                if (currentMode === 'freedom' && freedomDanmakuList && orderDanmakuList) {
                    // 移动弹幕内容：取自由模式列表的最后9条
                    const freedomItems = Array.from(freedomDanmakuList.children);
                    const itemsToMove = freedomItems.slice(-9); // 取最后9条
                    
                    // 清空秩序模式列表
                    orderDanmakuList.innerHTML = '';
                    
                    // 移动弹幕项到秩序模式列表
                    itemsToMove.forEach(item => {
                        const clonedItem = item.cloneNode(true);
                        orderDanmakuList.appendChild(clonedItem);
                    });
                    
                    // 清空自由模式列表
                    freedomDanmakuList.innerHTML = '';
                }
                
                if (freedomLayout) freedomLayout.style.display = 'none';
                if (orderLayout) orderLayout.style.display = 'block';
                currentMode = 'order';
                updateVoteLabels(); // 更新标签样式
            } else {
                // 从秩序模式切换到自由模式
                if (currentMode === 'order' && freedomDanmakuList && orderDanmakuList) {
                    // 移动弹幕内容：取秩序模式列表的所有内容
                    const orderItems = Array.from(orderDanmakuList.children);
                    
                    // 清空自由模式列表
                    freedomDanmakuList.innerHTML = '';
                    
                    // 移动弹幕项到自由模式列表
                    orderItems.forEach(item => {
                        const clonedItem = item.cloneNode(true);
                        freedomDanmakuList.appendChild(clonedItem);
                    });
                    
                    // 清空秩序模式列表
                    orderDanmakuList.innerHTML = '';
                }
                
                if (freedomLayout) freedomLayout.style.display = 'block';
                if (orderLayout) orderLayout.style.display = 'none';
                currentMode = 'freedom';
                updateVoteLabels(); // 更新标签样式
            }
        }
        
        // 更新秩序模式显示
        function updateOrderDisplay() {
            if (currentMode !== 'order' || !democracyInfo.commands) return;
            
            const commands = democracyInfo.commands;
            if (commands.length === 0) return;
            
            // 更新获胜指令显示
            const winningCommand = commands[0];
            const winningElement = document.getElementById('winning-command-text');
            if (winningElement) {
                winningElement.textContent = winningCommand[0];
            }
            
            // 更新前4名指令列表
            const commandList = document.getElementById('top-commands-list');
            if (commandList) {
                commandList.innerHTML = '';
                
                for (let i = 0; i < Math.min(3, commands.length); i++) {
                    const li = document.createElement('li');
                    li.className = 'command-item';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'command-name';
                    nameSpan.textContent = commands[i][0];
                    
                    const voteSpan = document.createElement('span');
                    voteSpan.className = 'command-votes';
                    voteSpan.textContent = commands[i][1];
                    
                    li.appendChild(nameSpan);
                    li.appendChild(voteSpan);
                    commandList.appendChild(li);
                }
                
                // 填充剩余空位为空行
                for (let i = commands.length; i < 3; i++) {
                    const li = document.createElement('li');
                    li.className = 'command-item';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'command-name';
                    nameSpan.innerHTML = '&nbsp;';
                    
                    const voteSpan = document.createElement('span');
                    voteSpan.className = 'command-votes';
                    voteSpan.innerHTML = '&nbsp;';
                    
                    li.appendChild(nameSpan);
                    li.appendChild(voteSpan);
                    commandList.appendChild(li);
                }
            }
        }
        
        // 更新秩序模式下的弹幕列表
        function updateOrderDanmaku(danmaku) {
            const orderDanmakuList = document.getElementById('order-danmaku-list');
            if (!orderDanmakuList) return;
            
            const li = document.createElement('li');
            li.className = 'danmaku-item';
            
            const usernameSpan = document.createElement('span');
            usernameSpan.className = 'username';
            usernameSpan.textContent = danmaku.username;
            
            const commandSpan = document.createElement('span');
            commandSpan.className = 'command';
            commandSpan.textContent = danmaku.command;
            
            li.appendChild(usernameSpan);
            li.appendChild(commandSpan);
            
            orderDanmakuList.appendChild(li);
            
            // 保持只显示最新9条
            while (orderDanmakuList.children.length > 9) {
                orderDanmakuList.removeChild(orderDanmakuList.firstChild);
            }
        }
        
        function addDanmaku(danmaku) {
            console.log('Adding danmaku:', danmaku);
            
            if (currentMode === 'order') {
                // 秩序模式：添加到秩序模式弹幕列表
                updateOrderDanmaku(danmaku);
            } else {
                // 自由模式：添加到原有弹幕列表
                const danmakuList = document.getElementById('danmaku-list');
                const li = document.createElement('li');
                li.className = 'danmaku-item';
                
                const usernameSpan = document.createElement('span');
                usernameSpan.className = 'username';
                usernameSpan.textContent = danmaku.username;
                
                const commandSpan = document.createElement('span');
                commandSpan.className = 'command';
                commandSpan.textContent = danmaku.command;

                li.appendChild(usernameSpan);
                li.appendChild(commandSpan);
                
                danmakuList.appendChild(li);
                
                // 保持只显示最新13条
                while (danmakuList.children.length > 13) {
                    danmakuList.removeChild(danmakuList.firstChild);
                }
                
                danmakuList.scrollTop = danmakuList.scrollHeight;
            }
        }
        
        function connectSSE() {
            console.log('Connecting to SSE stream...');
            eventSource = new EventSource('/api/danmaku/stream');
            
            eventSource.onopen = function(event) {
                console.log('SSE connection opened');
            };
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Received SSE data:', data);
                    
                    if (data.type === 'heartbeat') {
                        // 从服务器获取开始时间并启动本地计时器
                        if (data.start_time && !startTime) {
                            startTime = data.start_time;
                            startRuntimeTimer();
                        }
                        // 如果服务器提供了运行时间，解析并设置开始时间
                        if (data.runtime && !startTime) {
                            // 从运行时间字符串解析秒数
                            const runtimeMatch = data.runtime.match(/(\d+)d\s*(\d+)h\s*(\d+)m\s*(\d+)s/);
                            if (runtimeMatch) {
                                const [, days, hours, minutes, seconds] = runtimeMatch;
                                const totalSeconds = parseInt(days) * 86400 + parseInt(hours) * 3600 + parseInt(minutes) * 60 + parseInt(seconds);
                                startTime = Math.floor(Date.now() / 1000) - totalSeconds;
                                startRuntimeTimer();
                            }
                        }
                        // 更新模式信息
                        if (data.mode_info) {
                            modeInfo = data.mode_info;
                            updateVoteBar(modeInfo.freedom_support || 50, modeInfo.order_support || 50, false);
                            if (modeInfo.current_mode !== currentMode) {
                                switchLayout(modeInfo.current_mode);
                            }
                        }
                        // 更新秩序模式信息
                        if (data.democracy_info) {
                            democracyInfo = data.democracy_info;
                            updateOrderDisplay();
                        }
                    } else if (data.type === 'vote_update') {
                        // 投票更新事件
                        if (data.mode_info) {
                            modeInfo = data.mode_info;
                            // 检查是否需要强制触发抖动
                            const forceShake = data.should_shake || false;
                            updateVoteBar(modeInfo.freedom_support || 50, modeInfo.order_support || 50, true, forceShake);
                            if (data.mode_switched && modeInfo.current_mode !== currentMode) {
                                switchLayout(modeInfo.current_mode);
                            }
                        }
                    } else if (data.type === 'democracy_update') {
                        // 秩序模式实时更新事件
                        if (data.democracy_info) {
                            democracyInfo = data.democracy_info;
                            updateOrderDisplay();
                        }
                    } else if (data.username && data.command) {
                        // 这是弹幕数据
                        addDanmaku(data);
                    }
                } catch (error) {
                    console.error('Error parsing SSE data:', error);
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('SSE connection error:', event);
                eventSource.close();
                
                // 3秒后重新连接
                setTimeout(connectSSE, 3000);
            };
        }
        
        // 页面加载完成后连接SSE并初始化运行时间
        document.addEventListener('DOMContentLoaded', function() {
            // 如果页面已经有运行时间，解析并启动计时器
            const runtimeElement = document.getElementById('runtime');
            const currentRuntime = runtimeElement.textContent;
            
            // 尝试解析现有的运行时间格式 (如果是英文格式)
            const runtimeMatch = currentRuntime.match(/(\d+)d\s*(\d+)h\s*(\d+)m\s*(\d+)s/);
            if (runtimeMatch) {
                const [, days, hours, minutes, seconds] = runtimeMatch;
                const totalSeconds = parseInt(days) * 86400 + parseInt(hours) * 3600 + parseInt(minutes) * 60 + parseInt(seconds);
                startTime = Math.floor(Date.now() / 1000) - totalSeconds;
                startRuntimeTimer();
            }
            
            connectSSE();
        });
        
        // 页面卸载时关闭连接和计时器
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
            if (runtimeInterval) {
                clearInterval(runtimeInterval);
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>We Play</h1>
        <div class="subtitle">Pokémon</div>
        <div id="runtime">{{ runtime }}</div>
        <!-- 投票占比显示条 -->
        <div class="vote-bar-container">
            <div class="vote-bar-wrapper">
                <span class="vote-labels">自由</span>
                <div class="vote-bar">
                    <div id="vote-divider" class="vote-divider" style="left: 50%;">
                        <span id="vote-arrow" class="vote-arrow">&lt;</span>
                    </div>
                    <div id="vote-threshold" class="vote-threshold" style="left: 25%;"></div>
                </div>
                <span class="vote-labels">秩序</span>
            </div>
        </div>
        
        <!-- 自由模式布局 -->
        <div class="freedom-layout" {% if mode_info.current_mode == '秩序' %}style="display: none;"{% endif %}>
            <ul id="danmaku-list">
                {% for danmaku in danmaku_list %}
                    <li class="danmaku-item">
                        <span class="username">{{ danmaku['username'] }}</span>
                        <span class="command">{{ danmaku['command'] }}</span>
                    </li>
                {% endfor %}
            </ul>
        </div>
        
        <!-- 秩序模式布局 -->
        <div class="order-layout" {% if mode_info.current_mode != '秩序' %}style="display: none;"{% endif %}>
            <!-- 获胜指令大显示 -->
            <div class="winning-command">
                <div id="winning-command-text" class="command-display">
                    {% if democracy_info.commands %}
                        {{ democracy_info.commands[0][0] }}
                    {% else %}
                        ***
                    {% endif %}
                </div>
            </div>
            
            <!-- 前4名指令列表 -->
            <div class="top-commands">
                <ul id="top-commands-list" class="command-list">
                    {% set commands_to_show = democracy_info.commands[:3] if democracy_info.commands else [] %}
                    {% for i in range(3) %}
                        <li class="command-item">
                            {% if i < commands_to_show|length %}
                                <span class="command-name">{{ commands_to_show[i][0] }}</span>
                                <span class="command-votes">{{ commands_to_show[i][1] }}</span>
                            {% else %}
                                <span class="command-name">&nbsp;</span>
                                <span class="command-votes">&nbsp;</span>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
            
            <!-- 缩短的弹幕列表 -->
            <ul id="order-danmaku-list" class="order-danmaku">
                {% for danmaku in danmaku_list[-9:] %}
                    <li class="danmaku-item">
                        <span class="username">{{ danmaku['username'] }}</span>
                        <span class="command">{{ danmaku['command'] }}</span>
                    </li>
                {% endfor %}
            </ul>
        </div>
        
        <div class="instructions">
            <div style="text-align: center; line-height: 1.5; font-size: 0.9em;">
                <span class="command-key">ikjl</span> 上下左右 | <span class="command-key">A/B</span> 确认/取消 | <span class="command-key">开始/选择 </span> 功能键 | <span class="command-key">自由/秩序</span> 投票
            </div>
            <div style="text-align: center; font-size: 9px; color: #888;">
                按键+数字，如：i3、a5（重复执行）<br>
                组合指令：a3 b2 i 或 rk2 j4 i2（用空格连接,r前缀表示奔跑）
            </div>
        </div>
    </div>
</body>
</html>